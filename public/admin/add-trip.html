<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Schedule Trip</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        h1 { color: #2c3e50; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; }
        button { background: #27ae60; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
    <script>
        // Check authentication before page loads
        (async function() {
            try {
                const res = await fetch('/api/agent/me');
                if (res.status === 401) {
                    // Not logged in, redirect to login
                    window.location.href = '/admin/login.html';
                    return;
                }
                const agent = await res.json();
                // Store agent info for later use
                window.currentAgent = agent;
            } catch (err) {
                window.location.href = '/admin/login.html';
            }
        })();
    </script>
</head>
<body>
        <!-- ADD THIS TO EVERY ADMIN PAGE -->
        <div style="background: #2c3e50; padding: 15px;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <a href="/admin/transport-dashboard.html" style="color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 5px;">‚Üê Back to Dashboard</a>
            </div>
        </div>
    <div class="container">
        <h1>üìÖ Schedule New Trip</h1>
        <form id="tripForm">
            <div class="form-group">
                <label>Select Bus:</label>
                <select id="busId" required></select>
            </div>
            <div class="form-group">
                <label>Select Route:</label>
                <select id="routeId" required></select>
            </div>
            <div class="form-group">
                <label>Departure Date:</label>
                <input type="date" id="departureDate" required>
            </div>
            <div class="form-group">
                <label>Departure Time:</label>
                <input type="time" id="departureTime" required>
            </div>
            <button type="submit">Schedule Trip</button>
        </form>
    </div>

    <script>
        async function loadOptions() {
            // Load buses
            const busRes = await fetch('/api/buses');
            const buses = await busRes.json();
            const busSelect = document.getElementById('busId');
            buses.forEach(b => {
                busSelect.innerHTML += `<option value="${b.id}">${b.name} (${b.rows}x${b.columns})</option>`;
            });
            
            // Load routes
            const routeRes = await fetch('/api/routes');
            const routes = await routeRes.json();
            const routeSelect = document.getElementById('routeId');
            routes.forEach(r => {
                routeSelect.innerHTML += `<option value="${r.id}">${r.origin} ‚Üí ${r.destination} (MWK ${r.price})</option>`;
            });
        }
        
        loadOptions();
        
        document.getElementById('tripForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                bus_id: parseInt(document.getElementById('busId').value),
                route_id: parseInt(document.getElementById('routeId').value),
                departure_date: document.getElementById('departureDate').value,
                departure_time: document.getElementById('departureTime').value
            };
            
            const res = await fetch('/api/admin/add-trip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert('‚úÖ Trip scheduled! Trip ID: ' + result.tripId);
                e.target.reset();
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        });
// Add logout button functionality
        function addLogoutButton() {
            const header = document.querySelector('.header');
            if (header && !document.getElementById('logoutBtn')) {
                const logoutDiv = document.createElement('div');
                logoutDiv.style.float = 'right';
                logoutDiv.style.marginTop = '-50px';
                logoutDiv.innerHTML = `
                    <span style="color: white; margin-right: 15px;">üë§ ${window.currentAgent?.name || 'Agent'}</span>
                    <button id="logoutBtn" onclick="logout()" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                `;
                header.appendChild(logoutDiv);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/agent/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/admin/login.html';
                    });
            }
        }

// Add logout button after page loads
        document.addEventListener('DOMContentLoaded', addLogoutButton);
    </script>
</body>
</html>