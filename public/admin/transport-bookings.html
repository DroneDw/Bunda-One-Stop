<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Transport Bookings</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        .trip-selector { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 600; display: block; margin-bottom: 5px; }
        select, button { padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 100%; }
        button { background: #3498db; color: white; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .bookings-panel, .seat-map-panel { background: white; padding: 20px; border-radius: 10px; }
        
        .booking-item { padding: 15px; border-bottom: 1px solid #eee; }
        .booking-item:last-child { border-bottom: none; }
        .seat-number { font-size: 24px; font-weight: bold; color: #e74c3c; }
        .student-name { font-weight: bold; color: #2c3e50; }
        .payment-status { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .payment-status.pending { background: #f39c12; color: white; }
        .payment-status.paid { background: #27ae60; color: white; }
        
        .confirm-btn { background: #27ae60; padding: 8px 15px; font-size: 14px; margin-top: 10px; }
        .confirm-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .seat-grid { display: grid; gap: 5px; justify-content: center; margin-top: 20px; }
        .seat { width: 40px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; }
        .seat.available { background: #27ae60; }
        .seat.pending { background: #f39c12; }
        .seat.paid { background: #3498db; }
        .walkway { width: 20px; }
        .driver { grid-column: 1 / -1; text-align: center; background: #34495e; color: white; padding: 8px; border-radius: 5px; margin-bottom: 10px; }
    </style>
    <script>
        // Check authentication before page loads
        (async function() {
            try {
                const res = await fetch('/api/agent/me');
                if (res.status === 401) {
                    // Not logged in, redirect to login
                    window.location.href = '/admin/login.html';
                    return;
                }
                const agent = await res.json();
                // Store agent info for later use
                window.currentAgent = agent;
            } catch (err) {
                window.location.href = '/admin/login.html';
            }
        })();
    </script>
</head>
<body>
        <!-- ADD THIS TO EVERY ADMIN PAGE -->
        <div style="background: #2c3e50; padding: 15px;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <a href="/admin/transport-dashboard.html" style="color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 5px;">‚Üê Back to Dashboard</a>
            </div>
        </div>
    <div class="container">
        <h1>üöå Transport Bookings Manager</h1>
        
        <div class="trip-selector">
            <h3>Select Trip:</h3>
            <div class="form-group">
                <select id="tripSelect">
                    <option value="">-- Choose a trip --</option>
                </select>
            </div>
            <button onclick="loadTripBookings()">Load Bookings</button>
        </div>

        <div class="dashboard" id="dashboard" style="display: none;">
            <div class="bookings-panel">
                <h2>üìã Booking List</h2>
                <div id="bookingsList"></div>
            </div>
            
            <div class="seat-map-panel">
                <h2>ü™ë Seat Map</h2>
                <div id="seatMap"></div>
            </div>
        </div>
    </div>

    <script>
        // Load all trips on page load
        async function loadTrips() {
            const res = await fetch('/api/trips');
            const trips = await res.json();
            const select = document.getElementById('tripSelect');
            
            trips.forEach(trip => {
                select.innerHTML += `
                    <option value="${trip.id}">
                        ${trip.origin} ‚Üí ${trip.destination} | ${trip.bus_name} | ${new Date(trip.departure_date).toLocaleDateString()}
                    </option>
                `;
            });
        }
        
        async function loadTripBookings() {
            const tripId = document.getElementById('tripSelect').value;
            if (!tripId) return alert('Please select a trip');
            
            document.getElementById('dashboard').style.display = 'grid';
            
            // Load bookings
            const bookingsRes = await fetch(`/api/admin/trip/${tripId}/bookings`);
            const bookings = await bookingsRes.json();
            
            // Load seat map
            const seatRes = await fetch(`/api/trip/${tripId}/seats`);
            const { busInfo, bookedSeats } = await seatRes.json();
            
            displayBookings(bookings);
            displaySeatMap(busInfo, bookedSeats);
        }
        
        function displayBookings(bookings) {
            const list = document.getElementById('bookingsList');
            if (bookings.length === 0) {
                list.innerHTML = '<p>No bookings yet.</p>';
                return;
            }
            
            list.innerHTML = bookings.map(b => `
                <div class="booking-item">
                    <div class="seat-number">Seat #${b.seat_number}</div>
                    <div class="student-name">${b.student_name}</div>
                    <div>üìû ${b.student_phone}</div>
                    <div>üí∞ Fee: MWK ${b.booking_fee || '0'}</div>
                    <div class="payment-status ${b.payment_status}">${b.payment_status.toUpperCase()}</div>
                    ${b.payment_status === 'pending' ? 
                        `<button class="confirm-btn" onclick="confirmPayment(${b.id})">Confirm Payment</button>` : 
                        `<button class="confirm-btn" disabled>‚úÖ Paid</button>`
                    }
                </div>
            `).join('');
        }
        
        function displaySeatMap(busInfo, bookedSeats) {
            const seatMap = document.getElementById('seatMap');
            let html = `<div class="driver">üöç DRIVER</div>`;
            html += `<div class="seat-grid" style="grid-template-columns: repeat(${busInfo.columns + (busInfo.columns > busInfo.walkway_position ? 1 : 0)}, auto);">`;
            
            let seatNumber = 1;
            for (let r = 0; r < busInfo.rows; r++) {
                for (let c = 1; c <= busInfo.columns; c++) {
                    const status = bookedSeats[seatNumber] || 'available';
                    html += `<div class="seat ${status}">${seatNumber}</div>`;
                    if (c === busInfo.walkway_position) {
                        html += `<div class="walkway"></div>`;
                    }
                    seatNumber++;
                }
            }
            html += '</div>';
            seatMap.innerHTML = html;
        }
        
        async function confirmPayment(bookingId) {
            if (!confirm('Confirm this payment?')) return;
            
            const res = await fetch('/api/admin/confirm-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ booking_id: bookingId })
            });
            
            const result = await res.json();
            if (result.success) {
                alert('‚úÖ Payment confirmed!');
                loadTripBookings(); // Refresh the view
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        }
        
        loadTrips();
        // Add logout button functionality
        function addLogoutButton() {
            const header = document.querySelector('.header');
            if (header && !document.getElementById('logoutBtn')) {
                const logoutDiv = document.createElement('div');
                logoutDiv.style.float = 'right';
                logoutDiv.style.marginTop = '-50px';
                logoutDiv.innerHTML = `
                    <span style="color: white; margin-right: 15px;">üë§ ${window.currentAgent?.name || 'Agent'}</span>
                    <button id="logoutBtn" onclick="logout()" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                `;
                header.appendChild(logoutDiv);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/agent/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/admin/login.html';
                    });
            }
        }

// Add logout button after page loads
        document.addEventListener('DOMContentLoaded', addLogoutButton);
    </script>
</body>
</html>