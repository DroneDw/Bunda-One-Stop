<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header h1 { margin-bottom: 10px; }
        .nav-links { display: flex; gap: 20px; flex-wrap: wrap; }
        .nav-links a { color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 5px; transition: background 0.3s; }
        .nav-links a:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 24px; }
        .card p { color: #7f8c8d; margin-bottom: 20px; }
        .card button { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .card button:hover { background: #2980b9; }
        
        .icon { font-size: 48px; margin-bottom: 15px; }
        .bus-icon { color: #e74c3c; }
        .route-icon { color: #27ae60; }
        .trip-icon { color: #f39c12; }
        .booking-icon { color: #9b59b6; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 36px; font-weight: bold; color: #3498db; }
        .stat-label { color: #7f8c8d; margin-top: 10px; }
    </style>
    <script>
        // Check authentication before page loads
        (async function() {
            try {
                const res = await fetch('/api/agent/me');
                if (res.status === 401) {
                    // Not logged in, redirect to login
                    window.location.href = '/admin/login.html';
                    return;
                }
                const agent = await res.json();
                // Store agent info for later use
                window.currentAgent = agent;
            } catch (err) {
                window.location.href = '/admin/login.html';
            }
        })();
    </script>
</head>
<body>
    <div class="header">
        <h1>üöå Transport Admin Dashboard</h1>
        <div class="nav-links">
            <a href="/transport.html">üì± Student View</a>
            <a href="/admin/transport-dashboard.html">üè† Dashboard</a>
            <a href="/admin/add-bus.html">üöå Add Bus</a>
            <a href="/admin/add-route.html">üõ£Ô∏è Add Route</a>
            <a href="/admin/add-trip.html">üìÖ Add Trip</a>
            <a href="/admin/transport-bookings.html">üìã View Bookings</a>
            <a href="/index.html">üèòÔ∏è Back to Main Site</a>
            <!-- Add this where you show trip bookings -->
            <a href="/api/admin/trip/${tripId}/bookings/download" 
            class="download-btn" 
            target="_blank">
            üì• Download Booking List (CSV)
            </a>

            <style>
            .download-btn {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            margin: 20px 0;
            font-weight: bold;
            }
            .download-btn:hover {
            background: #219a52;
            }
            </style>
        </div>
    </div>

    <div class="container">
        <div class="stats" id="statsGrid"></div>
        
        <div class="dashboard-grid">
            <div class="card">
                <div class="icon bus-icon">üöå</div>
                <h3>Manage Buses</h3>
                <p>Add new buses and configure seat layouts</p>
                <button onclick="location.href='/admin/add-bus.html'">Add Bus</button>
            </div>
            
            <div class="card">
                <div class="icon route-icon">üõ£Ô∏è</div>
                <h3>Manage Routes</h3>
                <p>Create routes between cities with pricing</p>
                <button onclick="location.href='/admin/add-route.html'">Add Route</button>
            </div>

            <!-- ADD THIS NEW CARD -->
            <div class="card">
                <div class="icon" style="color: #9b59b6;">üë•</div>
                <h3>Manage Agents</h3>
                <p>Add new bus companies/agents</p>
                <button onclick="location.href='/admin/register-agent.html'">Register Agent</button>
            </div>
            
            <div class="card">
                <div class="icon trip-icon">üìÖ</div>
                <h3>Schedule Trips</h3>
                <p>Set departure dates and times for buses</p>
                <button onclick="location.href='/admin/add-trip.html'">Schedule Trip</button>
            </div>
            
            <div class="card">
                <div class="icon booking-icon">üìã</div>
                <h3>View Bookings</h3>
                <p>See all seat bookings and confirm payments</p>
                <button onclick="location.href='/admin/transport-bookings.html'">View Bookings</button>
            </div>
        </div>
    </div>

    <script>
        // Load dashboard stats

        async function loadStats() {
            try {
                const [buses, routes, trips, bookings] = await Promise.all([
                    fetch('/api/buses').then(r => r.json()),
                    fetch('/api/routes').then(r => r.json()),
                    fetch('/api/trips').then(r => r.json()),
                    fetch('/api/admin/bookings').then(r => r.json())
                ]);
                
                // Calculate revenue (20% of confirmed bookings)
                const confirmedBookings = bookings.filter(b => b.payment_status === 'paid');
                const totalRevenue = confirmedBookings.reduce((sum, b) => sum + (b.price * 0.2), 0);
                
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${buses.length}</div>
                        <div class="stat-label">Your Buses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${routes.length}</div>
                        <div class="stat-label">Available Routes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${trips.length}</div>
                        <div class="stat-label">Your Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${bookings.length}</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>
                    <div class="stat-card" style="grid-column: span 2; background: linear-gradient(135deg, #27ae60, #229954);">
                        <div class="stat-number" style="color: white;">MWK ${totalRevenue.toLocaleString()}</div>
                        <div class="stat-label" style="color: white;">Revenue (Confirmed)</div>
                    </div>
                `;
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }    
                loadStats();
// Add logout button functionality
        function addLogoutButton() {
            const header = document.querySelector('.header');
            if (header && !document.getElementById('logoutBtn')) {
                const logoutDiv = document.createElement('div');
                logoutDiv.style.float = 'right';
                logoutDiv.style.marginTop = '-50px';
                logoutDiv.innerHTML = `
                    <span style="color: white; margin-right: 15px;">üë§ ${window.currentAgent?.name || 'Agent'}</span>
                    <button id="logoutBtn" onclick="logout()" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                `;
                header.appendChild(logoutDiv);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/agent/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/admin/login.html';
                    });
            }
        }

// Add logout button after page loads
        document.addEventListener('DOMContentLoaded', addLogoutButton);
    </script>
</body>
</html>