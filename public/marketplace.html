<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Marketplace - CampusStay</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .business-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #00ff88;
      overflow: hidden;
      background: #000;
      z-index: 2;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    
    .business-badge img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .service-card {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
      background: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    
    .service-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 255, 136, 0.2);
    }
    
    .service-card > div > img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #0a0a0a;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
        <div class="logo">
            <i class="fas fa-store"></i>
            <span>Bunda One Stop</span>
        </div>
      <ul class="nav-menu">
        <li><a href="index.html"><i class="fas fa-home"></i> Accommodation</a></li>
        <li><a href="marketplace.html" class="active"><i class="fas fa-shopping-bag"></i> Marketplace</a></li>
        <li><a href="business-portal-login.html">longin</a></li>
      </ul>
      <div class="hamburger">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top: 100px;">
    <h1>Student Marketplace</h1>
    <p class="subtitle">Services tailored for students - Food, Laundry, Tutoring & More</p>
    
    <div class="filter-bar">
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="food">Food & Delivery</option>
        <option value="laundry">Laundry</option>
        <option value="tutoring">Tutoring</option>
        <option value="transport">Transport</option>
        <option value="stationery">Stationery</option>
      </select>
      <button onclick="filterServices()"><i class="fas fa-filter"></i> Filter</button>
    </div>

    <div id="servicesGrid" class="services-grid">
      <!-- Services will load here -->
    </div>
  </div>

  <script>
    async function loadServices() {
      const res = await fetch('/api/services');
      const services = await res.json();
      displayServices(services);
    }

    function displayServices(services) {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = services.map(s => `
        <div class="service-card" onclick="showServiceDetail(${s.id})">
          <div style="position: relative;">
            <img src="/uploads/${s.images.split(',')[0]}" alt="${s.name}" onerror="this.src='https://via.placeholder.com/300x200/1a1a1a/00ff88?text=${encodeURIComponent(s.name)}'">
            <div class="business-badge">
              <img src="/uploads/${s.business_logo}" alt="${s.business_name}" onerror="this.src='https://via.placeholder.com/40x40/00ff88/000000?text=B'">
            </div>
          </div>
          <div style="padding: 1rem;">
            <h3 style="margin: 0.5rem 0;">${s.name}</h3>
            <p style="color: #ccc; font-size: 0.9rem; margin: 0.5rem 0;">${s.description}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
              <span style="color: #00ff88; font-weight: bold;">MWK ${s.price.toLocaleString()}</span>
              <span style="color: #888; font-size: 0.85rem;">${s.duration}</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
              <i class="fas fa-store"></i> ${s.business_name}
            </div>
          </div>
        </div>
      `).join('');
    }

    function filterServices() {
      const category = document.getElementById('categoryFilter').value;
      fetch('/api/services').then(r => r.json()).then(services => {
        const filtered = category ? services.filter(s => s.category === category) : services;
        displayServices(filtered);
      });
    }
    
    async function showServiceDetail(id) {
      const res = await fetch(`/api/services/${id}`);
      const service = await res.json();
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
          <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
          <div class="service-detail-with-gallery">
              
              <!-- Image Gallery -->
              <div class="service-image-gallery">
              ${service.images.split(',').map(img => `
                  <img src="/uploads/${img}" alt="${service.name}" onclick="enlargeImage(this.src)" style="cursor: pointer;">
              `).join('')}
              </div>
              
              <!-- Service Info -->
              <div class="service-info">
              <h2>üì¶ ${service.name}</h2>
              <p class="by-business">by <strong>${service.business_name}</strong></p>
              <div class="service-meta">
                  <p>üíµ <span class="price">MWK ${service.price.toLocaleString()}</span></p>
                  <p>‚è±Ô∏è ${service.duration}</p>
                  <p>üìç ${service.location}</p>
                  <p>‚òéÔ∏è ${service.contact_phone}</p>
              </div>
              
              <h3>Book This Service</h3>
              <form onsubmit="bookService(event, ${service.id})">
                  <input type="text" name="student_name" placeholder="Your Full Name" required>
                  <input type="email" name="student_email" placeholder="Your Email" required>
                  <input type="tel" name="student_phone" placeholder="Your Phone" required>
                  <input type="date" name="booking_date" required>
                  <input type="time" name="booking_time" required>
                  <button type="submit"><i class="fas fa-calendar-check"></i> Book Service</button>
              </form>
              </div>
          </div>
          </div>
      `;
      document.body.appendChild(modal);
    }

    // Image enlargement function
    function enlargeImage(src) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0,0,0,0.95);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 3000;
          cursor: pointer;
      `;
      overlay.innerHTML = `<img src="${src}" style="max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 0 40px rgba(0,255,136,0.5);">`;
      overlay.onclick = () => overlay.remove();
      document.body.appendChild(overlay);
    }

    // ‚úÖ ADD THIS FUNCTION
    async function bookService(event, serviceId) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      const bookingData = {
        service_id: serviceId,
        student_name: formData.get('student_name'),
        student_email: formData.get('student_email'),
        student_phone: formData.get('student_phone'),
        booking_date: formData.get('booking_date'),
        booking_time: formData.get('booking_time')
      };
      
      try {
        const res = await fetch('/api/service-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookingData)
        });
        
        if (!res.ok) {
          const error = await res.text();
          alert('‚ùå Booking failed: ' + error);
          return;
        }
        
        const booking = await res.json();
        alert('‚úÖ Booking successful! Reference ID: ' + booking.id);
        
        // Close modal and reset form
        form.reset();
        document.querySelector('.modal').remove();
        
      } catch (error) {
        console.error('‚ùå BOOKING ERROR:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }
    
    loadServices();
  </script>
</body>
</html>